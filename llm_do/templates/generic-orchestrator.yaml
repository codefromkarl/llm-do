model: claude-haiku-4.5
defaults:
  max_units: 10
  sub_template: ""
system: |
  You turn free-form tasks into concrete multi-step workflows.
  Use the provided Files toolboxes to inspect the workspace and write new files:
  - Files_workspace_ro_* points at the current directory (read-only)
  - Files_workspace_out_* points at the same directory but allows writes
  Call TemplateCall_run to execute per-unit templates with tightly scoped context.
tools:
  - 'Files({"mode": "ro", "path": ".", "alias": "workspace_ro"})'
  - 'Files({"mode": "out", "path": ".", "alias": "workspace_out"})'
  - 'TemplateCall({"allow_templates": ["pkg:*", "templates/**/*.yaml", "./templates/**/*.yaml", "**/templates/**/*.yaml"], "allowed_suffixes": [".pdf", ".md", ".txt"], "max_attachments": 2, "max_bytes": 20000000})'
functions: |
  import json
  import os
  import re
  from textwrap import dedent

  def make_slug(text: str) -> str:
      slug = re.sub(r"[^a-z0-9]+", "-", text.lower()).strip("-")
      return slug or "workflow"

  def abs_path(relative: str) -> str:
      """Convert workspace-relative path to absolute path."""
      return os.path.abspath(relative)

  def scaffold_template(task: str) -> str:
      return dedent(
          f"""
          system: |
            You solve exactly one unit of work extracted from: {task}
            Respect any attached procedures/fragments.
            Provide a clear, well-structured response.
          prompt: |
            Carry out the task for your specific unit. Keep context focused.
            Provide your analysis and findings.
          """
      ).strip()

  def render_markdown(result: str, unit_name: str = "unit") -> str:
      """Wrap a free-text result in simple markdown."""
      return "\n".join(
          [
              f"# {unit_name}",
              "",
              result,
          ]
      )
prompt: |
  ## Task
  $input

  ## Parameters
  Sub-template path (blank = generate): "$sub_template"
  Max units: $max_units

  ## Instructions
  1. Parse the task to decide:
     - the unit of work (file, record, URL, etc.)
     - where the inputs live inside this directory
     - where outputs should be written
     - whether a procedure/spec file should be attached as fragments
  2. Discover candidate units using Files_workspace_ro_list (limit to $max_units).
  3. Pick the sub-template to run:
     - If $sub_template is provided, use abs_path($sub_template) to get the
       absolute path.
     - If $sub_template is blank, create `templates/generated/<slug>.yaml` using
       scaffold_template() via Files_workspace_out_write_text, then use
       abs_path("templates/generated/<slug>.yaml") to get the absolute path.
     - Mention the template path you're using in your reasoning and final summary.
  4. For each unit (up to $max_units):
     - Gather attachment paths (PDF/Markdown/Text only) and any relevant
       instructions/spec fragments you discovered earlier.
     - Call TemplateCall_run with `template` set to the absolute template path
       from step 3, plus the attachments and fragments. The response will be
       plain text.
     - Wrap the result using render_markdown(result, unit_name) and write it to
       the chosen output directory via Files_workspace_out_write_text.
  5. Finish by reporting how many units were processed, where outputs went, and
     which template should be reused next time (e.g. via `-p sub_template=...`).
